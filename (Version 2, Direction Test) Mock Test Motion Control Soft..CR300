'CR300 Series
'By: Fabian J. Matos Gierbolini
'Trajectory Algorithm CRBasic Iplementation

'Declaration of System Functions
AngleDegrees

'Declaration of variables
'Constants
Const numOfwp = 5
Const LOCAL_TIME_OFFSET = -6

'Trajectory variables declarations
Public WP(numOfwp*2) 'Array of trajectory, every two elements are a coodinate of the trajectory i.e longitude = WP(1)+2k while latitude = WP(2) + 2k.
Public nextWP = 1 'variable that acts as a pointer for the waypoint that the boat's trying to arrive to.
Public cEForce(2) 'variable to store anyca;culated force that acts upon the boat and changes it's trajectory.


'Declaring each of the GPS's data
Dim nmea_sentence(2) As String *100
Public GPSArray(15)
Public courseOverG, currLatitude, currLongitude, Speed

'PWM Signal variables and constants
Const PWM0 = 0.05 'initial power for thrusters.
Public delTheta
Const Gain = 0.005
Public WPdirection, PWML, PWMR

'Transmitter Communication Variables
Public Trans = -1
Public Test = 0
Public flag = True

DataTable(Table2,True,-1)
  DataInterval(0,1440,Min,10)
  Minimum(1,Trans,FP2,False,False)
EndTable


'Declaration of variable for distance comparison.
Public bTa, bTb
'These variables represent the distance of the boat to the next two closest waypoints in the trajectory
'bTa = Boat to Point A (Next Waypoint in the array) bTb = Boat to Point B (next of  next waypoint in the array).


'Main Program
BeginProg
  'Main Scan
  Scan (1,Sec,0,0)
    WP(1) = -15
    WP(2) = 0
    WP(3) = -20
    WP(4) = 10 
    WP(5) = -10
    WP(6) = 20
    'Main Loop
    'GPS Function, this will give us Longitude, Latitude, Speed and Course Over Ground. These are the measurements we need in order to make the algorithm.
    GPS(GPSArray,Com1,LOCAL_TIME_OFFSET*3600,100,nmea_sentence(1))
    currLatitude = GPSArray(1)
    currLongitude = GPSArray(3)
    Speed = GPSArray(5)
    courseOverG = GPSArray(7)

    'Delay (0,1,Sec)
    'Compares the magnitude of the current coordinate with the first waypoint or the next waypoint in the trajectory.
    'This Loop will keep going until the boat reaches it's destination.
    Do While (Round(SQR(PWR(currLatitude,2) + PWR(currLongitude,2)),2) = Round(SQR(PWR(WP((numOfwp*2)-1),2) + PWR(WP(numOfwp*2),2)),2)) AND flag
      WPdirection = ATN2(WP(nextWP+1) - currLongitude, WP(nextWP) - currLatitude) 'this is the direction angle the boat is supposed to have in reference to the next waypoint.
      delTheta = WPdirection - courseOverG 'Delta Theta; Difference in angle from supposed angle direction with actual angle direction.

      PWML = PWM0 - Gain*delTheta 'Equation for left Thruster Power.
      PWMR = PWM0 + Gain*delTheta  ' Equation for right Thruster Power.

      PWM(PWML,4,20,mSec) 'Function to turn on the left thrusters based on the result of the previous equation.
      PWM(PWMR,5,20,mSec) 'Function to turn on the left thrusters based on the result of the previous equation.
      Delay (0,1,Sec)
      'Checks if the Kill Switch is turned on every loop
      PulseCount(Test,1,SE1,0,1,1,0)

      'Calls the Table ans stores it. This is for testing ourposes
      CallTable(Table1)
      If Test > 0 Then
        flag = false
        Trans = Test
      EndIf
      'Delay program in order for the boat to be able to move.
      Delay (0,5,Sec)
    Loop
  NextScan
EndProg


